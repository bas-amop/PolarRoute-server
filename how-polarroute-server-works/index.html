<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>How PolarRoute-server works - PolarRoute-Server</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How PolarRoute-server works";
        var mkdocs_page_input_path = "how-polarroute-server-works.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> PolarRoute-Server
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../vehicle-management/">Vehicle Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../requesting-routes/">Requesting Routes</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">How PolarRoute-server works</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#polarroute-server-architecture">PolarRoute-server architecture</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ingesting-meshes-into-the-database">Ingesting meshes into the database</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#automatically">Automatically</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#manually">Manually</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#route-requests-and-jobs">Route requests and jobs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mesh-selection">Mesh selection</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deployment/">Deployment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../configuration/">Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../development/">Development</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../api/">API Reference</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Python Package API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../autoapi/polarrouteserver/">polarrouteserver</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../autoapi/polarrouteserver/demo/">demo</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/">route_api</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/utils/">utils</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../autoapi/polarrouteserver/route_api/views/">views</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../autoapi/polarrouteserver/version/">version</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">PolarRoute-Server</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">How PolarRoute-server works</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/bas-amop/polarroute-server/edit/main/docs/how-polarroute-server-works.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-polarroute-server-works">How PolarRoute-server works</h1>
<p>This page gives an overview of the architecture and approach of the software for developers or administrators of PolarRoute-server.</p>
<h2 id="polarroute-server-architecture">PolarRoute-server architecture</h2>
<p>As with all Django apps, PolarRoute-server follows a model-view-controller-like architecture (<a href="https://docs.djangoproject.com/en/5.1/faq/general/#django-appears-to-be-a-mvc-framework-but-you-call-the-controller-the-view-and-the-view-the-template-how-come-you-don-t-use-the-standard-names">see Django FAQ for the specifics</a>) in which a <code>models.py</code> file defines the tables in the database; <code>views.py</code> defines the handling of HTTP requests. Most Django apps also have templates, but since PolarRoute-server is headless, we don't need these.</p>
<p>In brief:</p>
<ol>
<li>User requests a route via POST request to the <code>/api/route</code> endpoint,</li>
<li>Route calculation is started as a celery job (defined in <code>tasks.py</code>) and the client is returned a URL from which it can request route status information.</li>
<li>Client polls the <code>/api/route/{uuid}</code> endpoint by GET request, status information is returned, and the route as well once it is complete.</li>
</ol>
<p>To calculate a route, PolarRoute requires a mesh that covers the area of the start and end points of the route.</p>
<h2 id="ingesting-meshes-into-the-database">Ingesting meshes into the database</h2>
<p>For the time-being, meshes are calculated separately to PolarRoute-server, either with PolarRoute-pipeline or with MeshiPhi directly.</p>
<p>The application takes <strong>vessel</strong> meshes, with the vessel transformation already applied.</p>
<p>Meshes can be ingested into the database manually or automatically.</p>
<p>By default, development deployments (using the <code>polarrouteserver/settings/development.py</code> settings) perform no automatic mesh ingestion, and production deployments (using the <code>polarrouteserver/settings/production.py</code> settings) use celery-beat to perform automatic ingestion of meshes every 10 minutes, running the <code>import_new_meshes</code> task (<code>polarrouteserver/route_api/tasks.py</code>).</p>
<h3 id="automatically">Automatically</h3>
<p>Meshes are found automatically in the directories specified using the <code>POLARROUTE_MESH_DIR</code> &amp; <code>POLARROUTE_MESH_METADATA_DIR</code> environment variables (see <a href="../configuration/">Configuration</a> for specific behaviour). Mesh metadata files produced by PolarRoute-pipeline are used to validate newly available meshes, only meshes which are not already in the database (determined using their md5 hash) are ingested. Mesh metadatafiles must be named according to the format <code>upload_metadata_*.yaml.gz</code> to be found.</p>
<h3 id="manually">Manually</h3>
<p>Individual or lists of mesh files can be ingested into the database by running the <code>insert_mesh</code> command using <code>django-admin</code> or <code>python manage.py</code>, e.g. <code>django-admin insert_mesh path/to/my/mesh.vessel.json</code>.</p>
<p><code>insert_mesh</code> can take <code>json</code> files or <code>json.gz</code> files.</p>
<h2 id="route-requests-and-jobs">Route requests and jobs</h2>
<p>When a route is requested, the <code>select_mesh</code> function is called to determine which mesh to use (described below in <a href="#mesh-selection">Mesh selection</a>) unless a specific mesh id is requested in the route request.</p>
<p>The <code>route_exists</code> function is called for the start and end points and the mesh selected, if there is already an existing route which was successful, this is returned unless the client specifies <code>force_new_route: true</code>, in which case the route is recalculated. Whether a route is considered to "exist" or not depends on a tolerance in the haversine distance of the requested start and end locations compared to routes which have already been calculated. This distance by default is 1 nautical mile (set by the <code>WAYPOINT_DISTANCE_TOLERANCE</code> setting). In other words, if a route is requested where the requested start point is within 1NM of a route already calculated and the same is true of the end point, this route is returned under default conditions. Note that if a newer mesh is available, a new route will be calculated.</p>
<p>Because route optimisation jobs can take several minutes, this is done by an asynchronous job queue managed by celery.</p>
<p>If the route optimisation fails, the next mesh in priority order is tried if the failure is due to the route being "inaccessible" on the mesh.</p>
<h2 id="mesh-selection">Mesh selection</h2>
<p>Before a route is calculated, a priority list of meshes is created by <code>polarrouteserver.route_api.utils.select_mesh</code>.</p>
<p>It takes all of the meshes that contain the requested start and end coordinates and that were created on the latest date available out of those meshes and returns this list of meshes sorted from smallest to largest total area.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../requesting-routes/" class="btn btn-neutral float-left" title="Requesting Routes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../deployment/" class="btn btn-neutral float-right" title="Deployment">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/bas-amop/polarroute-server/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../requesting-routes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../deployment/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
