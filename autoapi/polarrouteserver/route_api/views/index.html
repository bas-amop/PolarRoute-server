<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>views - PolarRoute-Server</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "views";
        var mkdocs_page_input_path = "autoapi/polarrouteserver/route_api/views.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> PolarRoute-Server
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../requesting-routes/">Requesting Routes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../how-polarroute-server-works/">How PolarRoute-server works</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../deployment/">Deployment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../configuration/">Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../development/">Development</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../../api/">API Reference</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Python Package API Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="../../">polarrouteserver</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../demo/">demo</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="../">route_api</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../utils/">utils</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" href="#">views</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">PolarRoute-Server</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Python Package API Reference</li>
          <li class="breadcrumb-item"><a href="../../">polarrouteserver</a></li>
          <li class="breadcrumb-item"><a href="../">route_api</a></li>
      <li class="breadcrumb-item active">views</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/home/runner/work/PolarRoute-server/PolarRoute-server/polarrouteserver/route_api/views.py" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="polarrouteserver.route_api.views"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="polarrouteserver.route_api.views.LoggingMixin" class="doc doc-heading">
            <code>LoggingMixin</code>


</h2>


    <div class="doc doc-contents ">


        <p>Provides full logging of requests and responses</p>







              <details class="quote">
                <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
                <pre class="highlight"><code class="language-python">class LoggingMixin:
    """
    Provides full logging of requests and responses
    """

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.logger = logging.getLogger("django.request")

    def initial(self, request, *args, **kwargs):
        try:
            self.logger.debug(
                {
                    "request": request.data,
                    "method": request.method,
                    "endpoint": request.path,
                    "user": request.user.username,
                    "ip_address": request.META.get("REMOTE_ADDR"),
                    "user_agent": request.META.get("HTTP_USER_AGENT"),
                }
            )
        except Exception:
            self.logger.exception("Error logging request data")

        super().initial(request, *args, **kwargs)

    def finalize_response(self, request, response, *args, **kwargs):
        try:
            self.logger.debug(
                {
                    "response": response.data,
                    "status_code": response.status_code,
                    "user": request.user.username,
                    "ip_address": request.META.get("REMOTE_ADDR"),
                    "user_agent": request.META.get("HTTP_USER_AGENT"),
                }
            )
        except Exception:
            self.logger.exception("Error logging response data")

        return super().finalize_response(request, response, *args, **kwargs)</code></pre>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="polarrouteserver.route_api.views.RecentRoutesView" class="doc doc-heading">
            <code>RecentRoutesView</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LoggingMixin (polarrouteserver.route_api.views.LoggingMixin)" href="#polarrouteserver.route_api.views.LoggingMixin">LoggingMixin</a></code>, <code><span title="rest_framework.generics.GenericAPIView">GenericAPIView</span></code></p>








              <details class="quote">
                <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
                <pre class="highlight"><code class="language-python">class RecentRoutesView(LoggingMixin, GenericAPIView):
    def get(self, request):
        """Get recent routes"""

        logger.info(
            f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
        )

        # only get today's routes
        routes_today = Route.objects.filter(requested__date=datetime.now().date())
        response_data = []
        logger.debug(f"Found {len(routes_today)} routes today.")
        for route in routes_today:
            logger.debug(f"{route.id}")
            try:
                job = route.job_set.latest("datetime")
            except Job.DoesNotExist:
                logger.debug(f"Job does not exist for route {route.id}")
                continue

            result = AsyncResult(id=str(job.id), app=app)
            status = result.state

            data = {
                "id": str(job.id),
                "status": status,
                "polarrouteserver-version": polarrouteserver_version,
            }

            data.update(RouteSerializer(route).data)

            if status == "FAILURE":
                data.update({"error": route.info})

            response_data.append(data)

        return Response(
            response_data,
            headers={"Content-Type": "application/json"},
            status=rest_framework.status.HTTP_200_OK,
        )</code></pre>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="polarrouteserver.route_api.views.RecentRoutesView.get" class="doc doc-heading">
            <code class="highlight language-python">get(request)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Get recent routes</p>


            <details class="quote">
              <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
              <pre class="highlight"><code class="language-python">def get(self, request):
    """Get recent routes"""

    logger.info(
        f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
    )

    # only get today's routes
    routes_today = Route.objects.filter(requested__date=datetime.now().date())
    response_data = []
    logger.debug(f"Found {len(routes_today)} routes today.")
    for route in routes_today:
        logger.debug(f"{route.id}")
        try:
            job = route.job_set.latest("datetime")
        except Job.DoesNotExist:
            logger.debug(f"Job does not exist for route {route.id}")
            continue

        result = AsyncResult(id=str(job.id), app=app)
        status = result.state

        data = {
            "id": str(job.id),
            "status": status,
            "polarrouteserver-version": polarrouteserver_version,
        }

        data.update(RouteSerializer(route).data)

        if status == "FAILURE":
            data.update({"error": route.info})

        response_data.append(data)

    return Response(
        response_data,
        headers={"Content-Type": "application/json"},
        status=rest_framework.status.HTTP_200_OK,
    )</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="polarrouteserver.route_api.views.RouteView" class="doc doc-heading">
            <code>RouteView</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LoggingMixin (polarrouteserver.route_api.views.LoggingMixin)" href="#polarrouteserver.route_api.views.LoggingMixin">LoggingMixin</a></code>, <code><span title="rest_framework.generics.GenericAPIView">GenericAPIView</span></code></p>








              <details class="quote">
                <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
                <pre class="highlight"><code class="language-python">class RouteView(LoggingMixin, GenericAPIView):
    serializer_class = RouteSerializer

    def post(self, request):
        """Entry point for route requests"""

        logger.info(
            f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}: {request.data}"
        )

        data = request.data

        # TODO validate request JSON
        start_lat = data["start_lat"]
        start_lon = data["start_lon"]
        end_lat = data["end_lat"]
        end_lon = data["end_lon"]
        start_name = data.get("start_name", None)
        end_name = data.get("end_name", None)
        custom_mesh_id = data.get("mesh_id", None)
        force_recalculate = data.get("force_recalculate", False)

        if custom_mesh_id:
            try:
                logger.info(f"Got custom mesh id {custom_mesh_id} in request.")
                meshes = [Mesh.objects.get(id=custom_mesh_id)]
            except Mesh.DoesNotExist:
                msg = f"Mesh id {custom_mesh_id} requested. Does not exist."
                logger.info(msg)
                return Response(
                    data={
                        "info": {"error": msg},
                        "status": "FAILURE",
                    },
                    headers={"Content-Type": "application/json"},
                    status=rest_framework.status.HTTP_202_ACCEPTED,
                )
        else:
            meshes = select_mesh(start_lat, start_lon, end_lat, end_lon)

        if meshes is None:
            return Response(
                data={
                    "info": {"error": "No suitable mesh available."},
                    "status": "FAILURE",
                },
                headers={"Content-Type": "application/json"},
                status=rest_framework.status.HTTP_200_OK,
            )

        logger.debug(f"Using meshes: {[mesh.id for mesh in meshes]}")
        # TODO Future: calculate an up to date mesh if none available

        existing_route = route_exists(meshes, start_lat, start_lon, end_lat, end_lon)

        if existing_route is not None:
            if not force_recalculate:
                logger.info(f"Existing route found: {existing_route}")
                response_data = RouteSerializer(existing_route).data
                if existing_route.job_set.count() &gt; 0:
                    existing_job = existing_route.job_set.latest("datetime")

                    response_data.update(
                        {
                            "info": {
                                "info": "Pre-existing route found and returned. To force new calculation, include 'force_recalculate': true in POST request."
                            },
                            "id": str(existing_job.id),
                            "status-url": reverse(
                                "route", args=[existing_job.id], request=request
                            ),
                            "polarrouteserver-version": polarrouteserver_version,
                        }
                    )

                else:
                    response_data.update(
                        {
                            "info": {
                                "error": "Pre-existing route was found but there was an error.\
                                To force new calculation, include 'force_recalculate': true in POST request."
                            }
                        }
                    )
                return Response(
                    data=response_data,
                    headers={"Content-Type": "application/json"},
                    status=rest_framework.status.HTTP_202_ACCEPTED,
                )
            else:
                logger.info(
                    f"Found existing route(s) but got force_recalculate={force_recalculate}, beginning recalculation."
                )

        logger.debug(
            f"Using mesh {meshes[0].id} as primary mesh with {[mesh.id for mesh in meshes[1:]]} as backup."
        )

        # Create route in database
        route = Route.objects.create(
            start_lat=start_lat,
            start_lon=start_lon,
            end_lat=end_lat,
            end_lon=end_lon,
            mesh=meshes[0],
            start_name=start_name,
            end_name=end_name,
        )

        # Start the task calculation
        task = optimise_route.delay(
            route.id, backup_mesh_ids=[mesh.id for mesh in meshes[1:]]
        )

        # Create database record representing the calculation job
        job = Job.objects.create(
            id=task.id,
            route=route,
        )

        # Prepare response data
        data = {
            "id": job.id,
            # url to request status of requested route
            "status-url": reverse("route", args=[job.id], request=request),
            "polarrouteserver-version": polarrouteserver_version,
        }

        return Response(
            data,
            headers={"Content-Type": "application/json"},
            status=rest_framework.status.HTTP_202_ACCEPTED,
        )

    def get(self, request, id):
        "Return status of route calculation and route itself if complete."

        logger.info(
            f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
        )

        # update job with latest state
        job = Job.objects.get(id=id)

        # status = job.status
        result = AsyncResult(id=str(id), app=app)
        status = result.state

        data = {
            "id": str(id),
            "status": status,
            "polarrouteserver-version": polarrouteserver_version,
        }

        data.update(RouteSerializer(job.route).data)

        if status == "FAILURE":
            data.update({"error": job.route.info})

        return Response(
            data,
            headers={"Content-Type": "application/json"},
            status=rest_framework.status.HTTP_200_OK,
        )

    def delete(self, request, id):
        """Cancel route calculation"""

        logger.info(
            f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
        )

        result = AsyncResult(id=str(id), app=app)
        result.revoke()

        return Response(
            {},
            headers={"Content-Type": "application/json"},
            status=rest_framework.status.HTTP_202_ACCEPTED,
        )</code></pre>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="polarrouteserver.route_api.views.RouteView.delete" class="doc doc-heading">
            <code class="highlight language-python">delete(request, id)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Cancel route calculation</p>


            <details class="quote">
              <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
              <pre class="highlight"><code class="language-python">def delete(self, request, id):
    """Cancel route calculation"""

    logger.info(
        f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
    )

    result = AsyncResult(id=str(id), app=app)
    result.revoke()

    return Response(
        {},
        headers={"Content-Type": "application/json"},
        status=rest_framework.status.HTTP_202_ACCEPTED,
    )</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="polarrouteserver.route_api.views.RouteView.get" class="doc doc-heading">
            <code class="highlight language-python">get(request, id)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Return status of route calculation and route itself if complete.</p>


            <details class="quote">
              <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
              <pre class="highlight"><code class="language-python">def get(self, request, id):
    "Return status of route calculation and route itself if complete."

    logger.info(
        f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}"
    )

    # update job with latest state
    job = Job.objects.get(id=id)

    # status = job.status
    result = AsyncResult(id=str(id), app=app)
    status = result.state

    data = {
        "id": str(id),
        "status": status,
        "polarrouteserver-version": polarrouteserver_version,
    }

    data.update(RouteSerializer(job.route).data)

    if status == "FAILURE":
        data.update({"error": job.route.info})

    return Response(
        data,
        headers={"Content-Type": "application/json"},
        status=rest_framework.status.HTTP_200_OK,
    )</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="polarrouteserver.route_api.views.RouteView.post" class="doc doc-heading">
            <code class="highlight language-python">post(request)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Entry point for route requests</p>


            <details class="quote">
              <summary>Source code in <code>polarrouteserver/route_api/views.py</code></summary>
              <pre class="highlight"><code class="language-python">def post(self, request):
    """Entry point for route requests"""

    logger.info(
        f"{request.method} {request.path} from {request.META.get('REMOTE_ADDR')}: {request.data}"
    )

    data = request.data

    # TODO validate request JSON
    start_lat = data["start_lat"]
    start_lon = data["start_lon"]
    end_lat = data["end_lat"]
    end_lon = data["end_lon"]
    start_name = data.get("start_name", None)
    end_name = data.get("end_name", None)
    custom_mesh_id = data.get("mesh_id", None)
    force_recalculate = data.get("force_recalculate", False)

    if custom_mesh_id:
        try:
            logger.info(f"Got custom mesh id {custom_mesh_id} in request.")
            meshes = [Mesh.objects.get(id=custom_mesh_id)]
        except Mesh.DoesNotExist:
            msg = f"Mesh id {custom_mesh_id} requested. Does not exist."
            logger.info(msg)
            return Response(
                data={
                    "info": {"error": msg},
                    "status": "FAILURE",
                },
                headers={"Content-Type": "application/json"},
                status=rest_framework.status.HTTP_202_ACCEPTED,
            )
    else:
        meshes = select_mesh(start_lat, start_lon, end_lat, end_lon)

    if meshes is None:
        return Response(
            data={
                "info": {"error": "No suitable mesh available."},
                "status": "FAILURE",
            },
            headers={"Content-Type": "application/json"},
            status=rest_framework.status.HTTP_200_OK,
        )

    logger.debug(f"Using meshes: {[mesh.id for mesh in meshes]}")
    # TODO Future: calculate an up to date mesh if none available

    existing_route = route_exists(meshes, start_lat, start_lon, end_lat, end_lon)

    if existing_route is not None:
        if not force_recalculate:
            logger.info(f"Existing route found: {existing_route}")
            response_data = RouteSerializer(existing_route).data
            if existing_route.job_set.count() &gt; 0:
                existing_job = existing_route.job_set.latest("datetime")

                response_data.update(
                    {
                        "info": {
                            "info": "Pre-existing route found and returned. To force new calculation, include 'force_recalculate': true in POST request."
                        },
                        "id": str(existing_job.id),
                        "status-url": reverse(
                            "route", args=[existing_job.id], request=request
                        ),
                        "polarrouteserver-version": polarrouteserver_version,
                    }
                )

            else:
                response_data.update(
                    {
                        "info": {
                            "error": "Pre-existing route was found but there was an error.\
                            To force new calculation, include 'force_recalculate': true in POST request."
                        }
                    }
                )
            return Response(
                data=response_data,
                headers={"Content-Type": "application/json"},
                status=rest_framework.status.HTTP_202_ACCEPTED,
            )
        else:
            logger.info(
                f"Found existing route(s) but got force_recalculate={force_recalculate}, beginning recalculation."
            )

    logger.debug(
        f"Using mesh {meshes[0].id} as primary mesh with {[mesh.id for mesh in meshes[1:]]} as backup."
    )

    # Create route in database
    route = Route.objects.create(
        start_lat=start_lat,
        start_lon=start_lon,
        end_lat=end_lat,
        end_lon=end_lon,
        mesh=meshes[0],
        start_name=start_name,
        end_name=end_name,
    )

    # Start the task calculation
    task = optimise_route.delay(
        route.id, backup_mesh_ids=[mesh.id for mesh in meshes[1:]]
    )

    # Create database record representing the calculation job
    job = Job.objects.create(
        id=task.id,
        route=route,
    )

    # Prepare response data
    data = {
        "id": job.id,
        # url to request status of requested route
        "status-url": reverse("route", args=[job.id], request=request),
        "polarrouteserver-version": polarrouteserver_version,
    }

    return Response(
        data,
        headers={"Content-Type": "application/json"},
        status=rest_framework.status.HTTP_202_ACCEPTED,
    )</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../utils/" class="btn btn-neutral float-left" title="utils"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/bas-amop/polarroute-server/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../utils/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
